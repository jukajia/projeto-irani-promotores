<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://docs.google.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net">
  <title>Painel do Gestor | Supermercado Irani</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="imagens/favicon-juka.png" type="image/png">
  
  <!-- Pr√©-conex√£o para CDNs -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- SheetJS (para Excel e CSV) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <!-- jsPDF + html2canvas (para PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
</head>
<body>
  <header>
    <img src="imagens/logo-irani.png" alt="Logo Irani" class="logo-topo" loading="lazy">
    <h1>Painel do Gestor</h1>
  </header>

  <main>
    <!-- Filtros -->
    <section class="filtros" aria-label="Filtros de dados">
      <div class="lojas">
        <button onclick="filtrarLoja('Todos')" aria-label="Mostrar todas as lojas">Todas</button>
        <button onclick="filtrarLoja('001')" aria-label="Filtrar loja Brasil">Brasil (001)</button>
        <button onclick="filtrarLoja('002')" aria-label="Filtrar loja Parque Verde">Parque Verde (002)</button>
        <button onclick="filtrarLoja('003')" aria-label="Filtrar loja Floresta">Floresta (003)</button>
        <button onclick="filtrarLoja('004')" aria-label="Filtrar loja Tancredo">Tancredo (004)</button>
        <button onclick="filtrarLoja('005')" aria-label="Filtrar loja Gourmet">Gourmet (005)</button>
        <button onclick="filtrarLoja('201')" aria-label="Filtrar loja Port√≠ 1">Port√≠ 1 (201)</button>
        <button onclick="filtrarLoja('202')" aria-label="Filtrar loja Port√≠ 2">Port√≠ 2 (202)</button>
        <button onclick="filtrarLoja('203')" aria-label="Filtrar loja Port√≠ 3">Port√≠ 3 (203)</button>
        <button onclick="filtrarLoja('204')" aria-label="Filtrar loja Port√≠ 4">Port√≠ 4 (204)</button>
      </div>

      <div class="search-container">
        <label for="buscaGestor" class="sr-only">Buscar em qualquer campo</label>
        <input type="text" id="buscaGestor" oninput="filtrarDadosGestor()" 
               placeholder="Buscar em qualquer campo..." aria-label="Campo de busca">
      </div>
    </section>

    <!-- Bot√µes de Exporta√ß√£o -->
    <section class="exportacoes" aria-label="Op√ß√µes de exporta√ß√£o">
      <button onclick="exportarExcel()" aria-label="Exportar para Excel">
        <span aria-hidden="true">üì•</span> Exportar Excel
      </button>
      <button onclick="exportarCSV()" aria-label="Exportar para CSV">
        <span aria-hidden="true">üßæ</span> Exportar CSV
      </button>
      <button onclick="exportarPDF()" aria-label="Exportar para PDF">
        <span aria-hidden="true">üìÑ</span> Exportar PDF
      </button>
      <button onclick="atualizarPlanilha()" aria-label="Atualizar dados">
        <span aria-hidden="true">üîÑ</span> Atualizar Dados
      </button>
      <span id="statusAtualiza" role="status" aria-live="polite"></span>
    </section>

    <!-- Gr√°ficos -->
    <section class="graficos" aria-label="Visualiza√ß√µes gr√°ficas">
      <div class="grafico-card" aria-label="Gr√°fico de atendimentos por loja">
        <canvas id="graficoLoja" role="img" aria-label="Gr√°fico de barras mostrando atendimentos por loja"></canvas>
      </div>
      <div class="grafico-card" aria-label="Gr√°fico de atendimentos por dia">
        <canvas id="graficoDia" role="img" aria-label="Gr√°fico de linhas mostrando atendimentos por dia"></canvas>
      </div>
      <div class="grafico-card" aria-label="Gr√°fico de atendimentos por promotor">
        <canvas id="graficoPromotor" role="img" aria-label="Gr√°fico de pizza mostrando atendimentos por promotor"></canvas>
      </div>
    </section>
    
    <!-- Ranking -->
    <section class="ranking-section" aria-label="Ranking de promotores">
      <h2><span aria-hidden="true">üèÜ</span> Ranking de Promotores</h2>
      <div class="ranking-cards">
        <div class="ranking-card" aria-label="Top marcas atendidas">
          <h3>Top Marcas Atendidas</h3>
          <ol id="topMarcas" aria-label="Lista das marcas mais atendidas"></ol>
        </div>
        <div class="ranking-card" aria-label="Maior cobertura de lojas">
          <h3>Maior Cobertura</h3>
          <ol id="topCobertura" aria-label="Lista de promotores com maior cobertura de lojas"></ol>
        </div>
      </div>
    </section>

    <!-- Tabela -->
    <section aria-label="Tabela de dados">
      <div class="table-responsive">
        <table id="tabelaGestor" aria-label="Dados completos dos promotores">
          <thead><tr id="cabecalhoGestor"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // Configura√ß√µes globais
    window.PLANILHA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrPYK0tixO-Ri8vEuchgH1nLv2uI1kISzupeWTOU2B_nLFE8kCmwUul4taiRfaxacnR3mVWMqOonTI/gviz/tq?tqx=out:json";
    
    // Verifica√ß√£o inicial
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.PLANILHA_URL) {
        console.error("URL da planilha n√£o definida");
        const status = document.getElementById("statusAtualiza");
        status.textContent = "‚ö†Ô∏è Erro: URL da planilha n√£o configurada";
        status.style.color = "#EF5350";
      }
      
      // Evento para recarregamento
      document.getElementById("statusAtualiza").addEventListener("click", ({target}) => {
        if (target.textContent.includes("Erro")) {
          localStorage.removeItem('dadosGestor');
          location.reload();
        }
      });
    });
  </script>
  
  <script src="js/gestor.js" defer></script>
</body>
</html>
